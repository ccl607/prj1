<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm-->
<!-- mapper 태그 선언 -->
<!--mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm-->
	<!-- namespace 속성값으로 [DAO 인터페이스명]이 오며 -->
	<!-- [DAO 인터페이스] 메소드명과 동일한 id 값을 소유한 태그를 내포하고 있다. -->
<!--mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm-->
<mapper namespace="com.group4.erp.dao.ApprovalDAO">


	<select id="getApprovalReqCnt" parameterType="com.group4.erp.ApprovalSearchDTO" resultType="int">
		select count(*) from e_works_info ap
		where 1=1
		and ap.emp_no = #{emp_no}
	</select>
	
	<select id="getApprovalResCnt" parameterType="com.group4.erp.ApprovalSearchDTO" resultType="int">
		select count(*) from e_works_info ap
		where 1=1
		and ap.mgr_emp_no = #{emp_no}
	</select>

	<select id="getApprovalReqList" parameterType="com.group4.erp.ApprovalSearchDTO" resultType="com.group4.erp.ApprovalDTO">
		select
			ap.e_works_no "e_works_no",
			ap.document_no "document_no",
			ap.emp_no "emp_no",
			(select e.emp_name from employee e where e.emp_no = ap.emp_no) "emp_name",
			mgr_emp_no "mgr_emp_no",
			(select e.emp_name from employee e where e.emp_no = ap.mgr_emp_no) "mgr_name",
			ap.e_works_req_dt "e_works_req_dt",
			ap.e_works_state_cd "e_works_state_cd",
			(select c.evnt_state_name from code_ad_state c where c.evnt_state_cd = ap.e_works_state_cd) "approval_state"
		from e_works_info ap
		where 1=1
		and ap.emp_no = #{emp_no}
	
	</select>
	
	<select id="getApprovalResList" parameterType="com.group4.erp.ApprovalSearchDTO" resultType="com.group4.erp.ApprovalDTO">
      	select
			ap.e_works_no "e_works_no",
			ap.document_no "document_no",
			ap.emp_no "emp_no",
			(select c.jikup from code_jikup c where c.jikup_cd = (select e.jikup_cd from employee e where e.emp_no =  #{emp_no}) ) "jikup",
			(select e.emp_name from employee e where e.emp_no =  #{emp_no}) "emp_name",
			mgr_emp_no "mgr_emp_no",
			(select e.emp_name from employee e where e.emp_no = ap.mgr_emp_no) "mgr_name",
			ap.e_works_req_dt "e_works_req_dt",
			ap.e_works_state_cd "e_works_state_cd",
			(select c.evnt_state_name from code_ad_state c where c.evnt_state_cd = ap.e_works_state_cd) "approval_state"
		from e_works_info ap
		where 1=1
		and ap.mgr_emp_no = #{emp_no}
	</select>
	
	
	<insert id="insertApproval" parameterType="com.group4.erp.ApprovalDTO">
		
		insert into e_works_info (
			e_works_no,
			document_no,
			emp_no,
			e_works_cd,
			mgr_emp_no,
			e_works_req_dt,
			e_works_res_dt,
			e_works_state_cd,
			e_work_comment		
		) values (
			(select nvl(max(e_works_no),0)+1 from e_works_info),
			#{document_no},
			#{emp_no},
			#{document_no},
			(select e.mgr_emp_no from employee e where e.emp_no = #{emp_no}),
			sysdate,
			null,
			'1',
			null
		)
			
	</insert>
	 
</mapper>